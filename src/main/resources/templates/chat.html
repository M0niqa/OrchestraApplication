<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .chat-container { height: 100vh; padding: 20px; display: flex; gap: 20px; }
        .user-list, .chat-box { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .user-list { width: 30%; }
        .chat-box { width: 70%; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .message { margin: 5px 0; }
        .sender-message { text-align: left; }
        .receiver-message { text-align: right; }
    </style>
</head>
<body>
<div class="container-fluid chat-container">
    <div class="user-list">
        <h5>Select User</h5>
        <label for="receiver"></label><select class="form-select mb-3" id="receiver" onchange="changeReceiver(this.value)">
            <option value="">-- Choose --</option>
            <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.firstName + ' ' + user.lastName}" th:selected="${user.id == receiverId}"></option>
        </select>

        <div class="list-group">
            <a th:each="partner : ${chatPartners}"
               th:href="@{/chat/{id}(id=${partner.id})}"
               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               th:attr="data-user-id=${partner.id}">
                <span th:text="${partner.firstName + ' ' + partner.lastName}"></span>
                <span class="badge bg-danger rounded-pill unread-badge"
                      th:if="${unreadFrom.contains(partner.id)}">ðŸ”´</span>
            </a>
        </div>
    </div>

    <div><h5 th:unless="${receiver != null and receiver.firstName != null and receiver.lastName != null}">Select a user to chat with</h5></div>

    <div th:if="${receiver != null and receiver.firstName != null and receiver.lastName != null}" class="chat-box">
        <h5>Chat with <span th:text="${receiver.firstName + ' ' + receiver.lastName}">[Receiver]</span></h5>
        <div id="messages">
            <th:block th:each="message : ${messages}">
                <div th:class="${message.senderId == senderId} ? 'sender-message' : 'receiver-message'">
                    <span th:class="${message.senderId == senderId} ? 'badge bg-primary' : 'badge bg-secondary'"
                          th:text="${message.messageContent}"></span>
                </div>
            </th:block>
        </div>
        <div class="input-group">
            <label for="message"></label><input type="text" id="message" class="form-control" placeholder="Type a message...">
            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<div id="chatData" th:data-sender-id="${senderId}" th:data-receiver-id="${receiverId}" style="display:none;"></div>

<script th:inline="javascript">
    const chatDataDiv = document.getElementById('chatData');
    const receiverId = chatDataDiv.dataset.receiverId;
    const senderId = chatDataDiv.dataset.senderId;
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/messages/' + senderId, (message) => {
                const msg = JSON.parse(message.body);
                if (String(msg.senderId) === String(receiverId) || String(msg.receiverId) === String(receiverId)) {
                    showMessage(msg);
                } else {
                    const badge = document.querySelector(`[data-user-id="${msg.senderId}"] .unread-badge`);
                    if (badge) badge.classList.remove('d-none');
                }
            });
        });
    }

    function sendMessage() {
        const messageContent = document.getElementById("message").value;
        if (!receiverId || !messageContent) return;

        const message = { senderId, receiverId, messageContent };
        stompClient.send("/app/chat", {}, JSON.stringify(message));
        document.getElementById("message").value = "";
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.className = "message " + (String(message.senderId) === String(senderId) ? "sender-message" : "receiver-message");
        messageElement.innerHTML = `<span class="badge ${String(message.senderId) === String(senderId) ? 'bg-primary' : 'bg-secondary'}">${message.messageContent}</span>`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function changeReceiver(newReceiverId) {
        if (newReceiverId) {
            window.location.href = '/chat/' + newReceiverId;
        }
    }

    window.onload = function () {
        connect();

        if (receiverId) {
            const badge = document.querySelector(`[data-user-id="${receiverId}"] .unread-badge`);
            if (badge) badge.classList.add('d-none');
        }

        const messagesDiv = document.getElementById("messages");
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    };

</script>
</body>
</html>
